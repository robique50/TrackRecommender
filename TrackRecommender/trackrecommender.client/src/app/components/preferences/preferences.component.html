<app-main-navbar></app-main-navbar>

<div class="preferences-container">
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading your preferences...</p>
    </div>
  </div>

  <div
    class="no-preferences-state"
    *ngIf="!isLoading && !hasPreferences && !isEditing"
  >
    <div class="empty-state-card">
      <div class="empty-icon">ğŸ¯</div>
      <h2>Welcome to Trail Preferences!</h2>
      <p>
        You haven't set up your trail preferences yet. Let's customize your
        trail recommendations to match your hiking style!
      </p>
      <button class="btn-primary btn-large" (click)="startConfiguration()">
        <span class="btn-icon">âš™ï¸</span>
        Configure Preferences
      </button>
    </div>
  </div>

  <div
    class="view-preferences-state"
    *ngIf="!isLoading && hasPreferences && !isEditing"
  >
    <div class="preferences-header">
      <h1>Your Trail Preferences</h1>
      <div class="header-actions">
        <button class="btn-secondary" (click)="editPreferences()">
          <span class="btn-icon">âœï¸</span>
          Edit
        </button>
        <button class="btn-danger" (click)="showResetConfirmation()">
          <span class="btn-icon">ğŸ”„</span>
          Reset
        </button>
      </div>
    </div>

    <div class="preferences-summary">
      <div class="pref-card">
        <div class="card-header">
          <span class="card-icon">ğŸ¥¾</span>
          <h3>Trail Types</h3>
        </div>
        <div class="card-content">
          <div class="tag-list">
            <span
              class="tag"
              *ngFor="let type of currentPreferences.preferredTrailTypes"
            >
              {{ type }}
            </span>
            <span
              class="empty-message"
              *ngIf="!currentPreferences.preferredTrailTypes?.length"
            >
              All trail types
            </span>
          </div>
        </div>
      </div>

      <div class="pref-card">
        <div class="card-header">
          <span class="card-icon">â›°ï¸</span>
          <h3>Preferred Difficulty</h3>
        </div>
        <div class="card-content">
          <div class="difficulty-display">
            <span
              class="difficulty-badge"
              [style.background-color]="
                getDifficultyColor(currentPreferences.preferredDifficulty)
              "
            >
              {{ currentPreferences.preferredDifficulty || "Not set" }}
            </span>
          </div>
        </div>
      </div>

      <div class="pref-card">
        <div class="card-header">
          <span class="card-icon">ğŸ“</span>
          <h3>Distance & Duration</h3>
        </div>
        <div class="card-content">
          <div class="metrics">
            <div class="metric">
              <span class="metric-label">Max Distance:</span>
              <span class="metric-value"
                >{{ currentPreferences.maxDistance }} km</span
              >
            </div>
            <div class="metric">
              <span class="metric-label">Max Duration:</span>
              <span class="metric-value">{{
                formatDuration(currentPreferences.maxDuration)
              }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="pref-card full-width">
        <div class="card-header">
          <span class="card-icon">ğŸ—ºï¸</span>
          <h3>Preferred Regions</h3>
        </div>
        <div class="card-content">
          <div class="regions-display">
            <div
              class="region-chip"
              *ngFor="let region of currentPreferences.preferredRegionNames"
            >
              {{ region }}
            </div>
            <span
              class="empty-message"
              *ngIf="!currentPreferences.preferredRegionNames?.length"
            >
              All regions
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="edit-preferences-state" *ngIf="!isLoading && isEditing">
    <form [formGroup]="preferencesForm" (ngSubmit)="savePreferences()">
      <div class="edit-header">
        <h1>{{ hasPreferences ? "Edit" : "Configure" }} Your Preferences</h1>
        <button type="button" class="btn-text" (click)="cancelEdit()">
          Cancel
        </button>
      </div>

      <div class="preference-section">
        <div class="section-header">
          <h3>ğŸ¥¾ What type of trails do you enjoy?</h3>
          <p class="section-description">Select all that apply</p>
        </div>
        <div class="option-grid">
          <label
            class="option-card"
            *ngFor="let type of availableTrailTypes"
            [class.selected]="isTrailTypeSelected(type)"
          >
            <input
              type="checkbox"
              [checked]="isTrailTypeSelected(type)"
              (change)="toggleTrailType(type)"
            />
            <span class="option-content">
              <span class="option-icon">{{ getTrailTypeIcon(type) }}</span>
              <span class="option-label">{{ type }}</span>
            </span>
          </label>
        </div>
      </div>

      <div class="preference-section">
        <div class="section-header">
          <h3>â›°ï¸ Preferred Difficulty Level</h3>
          <p class="section-description">Choose your comfort zone</p>
        </div>
        <div class="difficulty-selector">
          <label
            class="difficulty-option"
            *ngFor="let diff of availableDifficulties"
            [class.selected]="
              preferencesForm.get('preferredDifficulty')?.value === diff
            "
          >
            <input
              type="radio"
              formControlName="preferredDifficulty"
              [value]="diff"
            />
            <span
              class="difficulty-card"
              [style.border-color]="getDifficultyColor(diff)"
            >
              <span
                class="diff-indicator"
                [style.background-color]="getDifficultyColor(diff)"
              ></span>
              <span class="diff-label">{{ diff }}</span>
            </span>
          </label>
        </div>
      </div>

      <div class="preference-section">
        <div class="section-header">
          <h3>ğŸ“ Trail Length Preferences</h3>
          <p class="section-description">Set your limits</p>
        </div>
        <div class="sliders-container">
          <div class="slider-group">
            <label>Maximum Distance</label>
            <div class="slider-wrapper">
              <input
                type="range"
                formControlName="maxDistance"
                min="1"
                max="100"
                step="0.5"
                class="modern-slider"
              />
              <span class="slider-value"
                >{{ preferencesForm.get("maxDistance")?.value }} km</span
              >
            </div>
          </div>
          <div class="slider-group">
            <label>Maximum Duration</label>
            <div class="slider-wrapper">
              <input
                type="range"
                formControlName="maxDuration"
                min="0.5"
                max="24"
                step="0.5"
                class="modern-slider"
              />
              <span class="slider-value">{{
                formatDuration(preferencesForm.get("maxDuration")?.value)
              }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="preference-section">
        <div class="section-header">
          <h3>ğŸ—ºï¸ Preferred Regions</h3>
          <p class="section-description">Where do you like to explore?</p>
        </div>

        <div class="region-search">
          <input
            type="text"
            placeholder="Search regions..."
            [(ngModel)]="regionSearchQuery"
            [ngModelOptions]="{ standalone: true }"
            (input)="filterRegions()"
            class="search-input"
          />
        </div>

        <div class="regions-carousel">
          <button
            type="button"
            class="carousel-arrow left"
            (click)="scrollRegions('left')"
            [disabled]="regionScrollIndex === 0"
          >
            â†
          </button>

          <div class="regions-container" #regionsContainer>
            <div
              class="region-card"
              *ngFor="let region of visibleRegions"
              [class.selected]="isRegionSelected(region.name)"
              (click)="toggleRegion(region.name)"
            >
              <div class="region-name">{{ region.name }}</div>
              <div class="region-trails">{{ region.trailCount }} trails</div>
              <div class="region-check" *ngIf="isRegionSelected(region.name)">
                âœ“
              </div>
            </div>
          </div>

          <button
            type="button"
            class="carousel-arrow right"
            (click)="scrollRegions('right')"
            [disabled]="regionScrollIndex >= maxRegionScroll"
          >
            â†’
          </button>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="cancelEdit()">
          Cancel
        </button>
        <button type="submit" class="btn-primary" [disabled]="isSaving">
          <span *ngIf="!isSaving">Save Preferences</span>
          <span *ngIf="isSaving" class="saving-spinner">Saving...</span>
        </button>
      </div>
    </form>
  </div>

  <div class="modal-overlay" *ngIf="showResetModal" (click)="closeResetModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>ğŸ”„ Reset Preferences?</h3>
      <p>
        Are you sure you want to reset all your preferences? This action cannot
        be undone.
      </p>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeResetModal()">
          Cancel
        </button>
        <button class="btn-danger" (click)="confirmReset()">Yes, Reset</button>
      </div>
    </div>
  </div>

  <div class="success-toast" *ngIf="showSuccessMessage" [@slideIn]>
    <span class="toast-icon">âœ…</span>
    <span>{{ successMessage }}</span>
  </div>
</div>
